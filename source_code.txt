#include <Servo.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// Components
Servo door; 
LiquidCrystal_I2C lcd(0x27, 16, 2);

// Ultrasonic Sensors
const int trigPin1 = 2;
const int echoPin1 = 3;

const int trigPin2 = 8;
const int echoPin2 = 9;

// Indicators
const int greenLed = 5;
const int redLed = 6;
const int buzzerPin = 7;

// Variables
long duration1, duration2;
int distance1, distance2;

bool isOpen = false;
unsigned long openTime = 0;

// Counters
int enterCount = 0;
int exitCount = 0;
int closeCount = 0;


// SETUP
void setup() {

  Serial.begin(9600);
  door.attach(4);

  // Sensor Pins
  pinMode(trigPin1, OUTPUT);
  pinMode(echoPin1, INPUT);

  pinMode(trigPin2, OUTPUT);
  pinMode(echoPin2, INPUT);

  // LEDs & Buzzer
  pinMode(greenLed, OUTPUT);
  pinMode(redLed, OUTPUT);
  pinMode(buzzerPin, OUTPUT);

  // Initial Door State = Closed
  door.write(0);
  digitalWrite(redLed, HIGH);
  digitalWrite(greenLed, LOW);
  noTone(buzzerPin);

  // LCD Setup
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
  lcd.print("Welcome! To Our");
  lcd.setCursor(0,1);
  lcd.print("Auto Door System");

  Serial.println("System Ready! Let's Do It");
}


// TIME FORMAT (HH:MM:SS)
String formatTime(unsigned long totalSeconds) {
  unsigned int hours = totalSeconds / 3600;
  unsigned int minutes = (totalSeconds % 3600) / 60;
  unsigned int seconds = totalSeconds % 60;

  char buffer[9];
  sprintf(buffer, "%02u:%02u:%02u", hours, minutes, seconds);
  return String(buffer);
}


// LOOP
void loop() {

  // Read Sensor 1
  digitalWrite(trigPin1, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin1, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin1, LOW);
  duration1 = pulseIn(echoPin1, HIGH);
  distance1 = duration1 * 0.034 / 2;

  // Read Sensor 2 
  digitalWrite(trigPin2, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin2, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin2, LOW);
  duration2 = pulseIn(echoPin2, HIGH);
  distance2 = duration2 * 0.034 / 2;

  // Serial Monitoring
  Serial.print("Distance1: ");
  Serial.print(distance1);
  Serial.print(" cm, Distance2: ");
  Serial.print(distance2);
  Serial.println(" cm");

  unsigned long currentTimeSec = millis() / 1000;
  String timeStr = formatTime(currentTimeSec);

  // WELCOME MESSAGE
  if (distance1 > 0 && distance1 < 10) {
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Welcome! Please");
    lcd.setCursor(0,1);
    lcd.print("Come In!");
    delay(1000);
  }

  // DOOR OPEN
  if ((distance1 > 0 && distance1 < 10) || (distance2 > 0 && distance2 < 6)) {
    if (!isOpen) {
      door.write(90);
      digitalWrite(greenLed, HIGH);
      digitalWrite(redLed, LOW);
      tone(buzzerPin, 800, 300);

      isOpen = true;
      openTime = millis();

      lcd.clear();
      lcd.setCursor(1,0);
      lcd.print("Door is Opening!");
      delay(1000);
    }
  }

  // ENTER COUNT
  if (distance1 > 0 && distance1 < 10) {

    enterCount++;

    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Entered Count:");
    lcd.print(enterCount);

    lcd.setCursor(0,1);
    lcd.print("At: ");
    lcd.print(timeStr);
    delay(3000);

    Serial.print("Door OPEN Time: ");
    Serial.print(timeStr);
    Serial.print(" Count: ");
    Serial.println(enterCount);
  }

  // EXIT COUNT
  if (distance2 > 0 && distance2 < 6) {

    exitCount++;

    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Exited Count:");
    lcd.print(exitCount);

    lcd.setCursor(0,1);
    lcd.print("At: ");
    lcd.print(timeStr);
    delay(3000);

    Serial.print("Door OPEN Time: ");
    Serial.print(timeStr);
    Serial.print(" Count: ");
    Serial.println(exitCount);
  }

  // DOOR CLOSE
  if (isOpen && (distance1 >= 10 && distance2 >= 6)) {

    delay(1000);
    door.write(0);

    digitalWrite(greenLed, LOW);
    digitalWrite(redLed, HIGH);
    tone(buzzerPin, 600, 200);

    isOpen = false;
    closeCount++;

    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Door is Closing!");
    delay(1000);

    // SHOW DOOR CLOSING TIME
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("Door Closed!");
    lcd.setCursor(0,1);
    lcd.print("At: ");
    lcd.print(timeStr);
    delay(3000);

    // Goodbye message only if no one in exit sensor
    if (distance2 >= 6) {
      lcd.clear();
      lcd.setCursor(1,0);
      lcd.print("Have a Good Day!");
      delay(1000);
    }

    Serial.print("Door CLOSE Time: ");
    Serial.print(timeStr);
    Serial.print(" Count: ");
    Serial.println(closeCount);
  }

  delay(100);
}
